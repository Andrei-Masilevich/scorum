<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Scorum: What is an API</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Scorum
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">What is an API </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>An API is a set of related methods, accessible over Websocket / HTTP and provided by a single C++ class. API's exist on a per-connection basis.</p>
<h1><a class="anchor" id="autotoc_md20"></a>
Compiling with hello_api plugin</h1>
<p>We will use the <code>hello_api</code> example plugin. To follow along with the examples, you may enable the <code>hello_api</code> example plugin by running the following command and recompiling: </p><pre class="fragment">ln -s ../example_plugins/hello_api external_plugins/hello_api
</pre> <h1><a class="anchor" id="autotoc_md21"></a>
Publicly available API's</h1>
<p>Some API's are public API's which are available to clients without login. These API's may be specified as follows in the configuration file: </p><pre class="fragment">public-api = database_api login_api hello_api_api
</pre><p> Note, <code>hello_api</code> is the name of the plugin and <code>hello_api_api</code> is the name of the API it provides. This slightly confusing naming may be revised in a later version of the plugin.</p>
<p>You may also specify <code>--public-api</code> on the command line.</p>
<p>Server configuration note: If you customize <code>public-api</code> configuration, you should set the first two API's to <code>database_api</code> and <code>login_api</code>.</p>
<p>For experts: The reason for recommending <code>database_api</code> and <code>login_api</code> to be the first two API's is that many clients expect these to be first two API's. Additionally, the string API identifier feature's FC implementation requires a working <code>get_api_by_name</code> method to be available on API ID 1, so effectively any client that uses string API identifiers (as recommended) requires <code>login_api</code> to be on API ID 1 even if no client uses the login feature.</p>
<h1><a class="anchor" id="autotoc_md22"></a>
Numeric API identifiers</h1>
<p>API's are assigned numeric ID's in the order they are specified as public API's. So for example you can access <code>hello_api_api</code> over HTTP like this: </p><pre class="fragment">curl --data '{"jsonrpc": "2.0", "params": [2, "get_message", []], "id":1, "method":"call"}' http://127.0.0.1:8090/rpc
</pre><p> The number <code>2</code> is the numeric API identifier for <code>hello_api_api</code>. These identifiers are assigned sequentially starting with 0 when the API is registered to the connection. So effectively this means numeric API identifiers are determined by the order of <code>hello_api_api</code> in the <code>public-api</code> declaration above.</p>
<p>The <code>get_api_by_name</code> method on API 1 (the <code>login_api</code>) can be used to query the numeric ID by name: </p><pre class="fragment">curl --data '{"jsonrpc": "2.0", "params": [1, "get_api_by_name", ["hello_api_api"]], "id":1, "method":"call"}' http://127.0.0.1:8790/rpc
</pre> <h1><a class="anchor" id="autotoc_md23"></a>
String API identifiers</h1>
<p>Client code that references API's by their numeric identifiers have to coordinated with server-side configuration. This is inconvenient, so the API server supports identifying the API by name as well, like this: </p><pre class="fragment">curl --data '{"jsonrpc": "2.0", "params": ["hello_api_api", "get_message", []], "id":1, "method":"call"}' http://127.0.0.1:8090/rpc
</pre><p> It is considered best practice for API clients to use this syntax to reference API's by their string identifiers. The reason is that the client becomes robust against server-side configuration changes which result in renumbering of API's.</p>
<h1><a class="anchor" id="autotoc_md24"></a>
API access control methods</h1>
<p>There are three methods to secure the API:</p>
<ul>
<li>Limit access to the API socket to a trusted machine by binding the RPC server to localhost</li>
<li>Limit access to the API socket to a trusted LAN by firewall configuration</li>
<li>Limit access to particular API's with username/password authentication</li>
</ul>
<p>The Scorum developers recommend using the first of these methods to secure the API by binding to localhost, as follows: </p><pre class="fragment">rpc-endpoint = 127.0.0.1:8090
</pre> <h1><a class="anchor" id="autotoc_md25"></a>
Securing specific API's</h1>
<p>The problem with securing API's at the network level is that there are deployment scenarios where a node may want to have some API's public, but other API's private. The <code>scorumd</code> process includes username/password based authentication to individual API's.</p>
<p>Since the username/password is sent directly over the wire, you should use a TLS connection when authenticating with username and password. TLS connection can be achieved by one of two methods:</p>
<ul>
<li>Configure an <code>rpc-tls-endpoint</code>.</li>
<li>Configure an <code>rpc-endpoint</code> bound to localhost (or a secure LAN), and use an external reverse proxy (for example, <code>nginx</code>). This advanced configuration will not be covered here.</li>
</ul>
<p>You will need to create a key and certificate for the server in <code>.pem</code> format. Many tutorials for creating SSL certificates exist, and many providers allow creating SSL certificates signed by widely recognized CA's. If you have a working <code>openssl</code> installation you can use these commands to generate a self-signed certificate: </p><pre class="fragment">openssl req -x509 -newkey rsa:4096 -keyout data/ss-key.pem -out data/ss-cert.pem -days 365
cat data/ss-{cert,key}.pem &gt; data/ss-cert-key.pem
</pre><p> Then in your <code>config.ini</code> you must give the server access to the key and certificate: </p><pre class="fragment">rpc-tls-endpoint = 0.0.0.0:8091
server-pem = data/ss-cert-key.pem
server-pem-password = password
</pre><p> When connecting to the API, you can use the <code>cli_wallet</code> to honor a specific certificate, individual CA, or CA bundle file with the <code>-a</code> option: </p><pre class="fragment">programs/cli_wallet/cli_wallet -s wss://mydomain.tld:8091 -a data/ss-cert.pem
</pre><p> Note that the hostname <code>mydomain.tld</code> needs to match the CN field in the certificate.</p>
<p>Now let's protect the <code>hello_api_api</code> API to only be usable by user <code>bytemaster</code> with password <code>supersecret</code>. Modify the <code>config.ini</code> file to make sure we have the correct plugin which provides the sensitive API, make sure the sensitive API is not accessible in <code>public-api</code>, and add an <code>api-user</code> definition to define the access policy: </p><pre class="fragment">enable-plugin = witness blockchain_history hello_api
public-api = database_api login_api
api-user = {"username" : "bytemaster", "password_hash_b64" : "T2k/wMBB9BKyv7X+ngghL+MaoubEuFb6GWvF3qQ9NU0=", "password_salt_b64" : "HqK9mAQCkWU=", "allowed_apis" : ["hello_api_api"]}
</pre><p> The values of <code>password_hash_b64</code> and <code>password_salt_b64</code> are generated by running <code>programs/util/saltpass.py</code> and entering your desired password.</p>
<p>Username/password access is only available through websockets, since login is inherently <em>stateful</em>. We can use the <code>wscat</code> program to demonstrate the login functionality: </p><pre class="fragment">wscat -c wss://mydomain.tld:8091
{"jsonrpc": "2.0", "params": ["database_api", "get_dynamic_global_properties", []], "id":1, "method":"call"}
&lt; (ok)
{"jsonrpc": "2.0", "params": ["hello_api_api", "get_message", []], "id":2, "method":"call"}
&lt; (error)
{"jsonrpc": "2.0", "params": ["login_api", "login", ["bytemaster", "supersecret"]], "id":3, "method":"call"}
&lt; (ok)
{"jsonrpc": "2.0", "params": ["hello_api_api", "get_message", []], "id":4, "method":"call"}
&lt; (ok)
</pre><p> The <code>cli_wallet</code> also has the capability to login to provide access to restricted API's. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu May 19 2022 13:53:31 for Scorum by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
