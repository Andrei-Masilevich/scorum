<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Scorum: Curation curve introduction</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Scorum
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Curation curve introduction </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In this document we derive the approximate integer square root function used by Scorum for the curation curve</p>
<h1><a class="anchor" id="autotoc_md60"></a>
MSB function</h1>
<p>Let function <code>msb(x)</code> be defined as follows for <code>x &gt;= 1</code>:</p>
<ul>
<li>(Definition 1a) <code>msb(x)</code> is the index of the most-significant 1 bit in the binary representation of <code>x</code></li>
</ul>
<p>The following definitions are equivalent to Definition (1a):</p>
<ul>
<li>(Definition 1b) <code>msb(x)</code> is the length of the binary representation of <code>x</code> as a string of bits, minus one</li>
<li>(Definition 1c) <code>msb(x)</code> is the greatest integer such that <code>2 ^ msb(x) &lt;= x</code></li>
<li>(Definition 1d) <code>msb(x) = floor(log_2(x))</code></li>
</ul>
<p>Many CPU's (including Intel CPU's since the Intel 386) can compute the <code>msb()</code> function very quickly on machine-word-size integers with a special instruction directly implemented in hardware. In C++, the Boost library provides reasonably compiler-independent, hardware-independent access to this functionality with <code>boost::multiprecision::detail::find_msb(x)</code>.</p>
<h1><a class="anchor" id="autotoc_md61"></a>
Approximate logarithms</h1>
<p>According to Definition 1d, <code>msb(x)</code> is already a (somewhat crude) approximate base-2 logarithm. The bits below the most-significant bit provide the fractional part of the linear interpolation. The fractional part is called the <em>mantissa</em> and the integer part is called the <em>exponent</em>; effectively we have re-invented the floating-point representation.</p>
<p>Here are some Python functions to convert to/from these approximate logarithms:</p>
<div class="fragment"><div class="line">def to_log(x, wordsize=32, ebits=5):</div>
<div class="line">    if x &lt;= 1:</div>
<div class="line">        return x</div>
<div class="line">    # mantissa_bits, mantissa_mask are independent of x</div>
<div class="line">    mantissa_bits = wordsize - ebits</div>
<div class="line">    mantissa_mask = (1 &lt;&lt; mantissa_bits)-1</div>
<div class="line"> </div>
<div class="line">    msb = x.bit_length() - 1</div>
<div class="line">    mantissa_shift = mantissa_bits - msb</div>
<div class="line">    y = (msb &lt;&lt; mantissa_bits) | ((x &lt;&lt; mantissa_shift) &amp; mantissa_mask)</div>
<div class="line">    return y</div>
<div class="line"> </div>
<div class="line">def from_log(y, wordsize=32, ebits=5):</div>
<div class="line">    if y &lt;= 1:</div>
<div class="line">        return y</div>
<div class="line">    # mantissa_bits, leading_1, mantissa_mask are independent of x</div>
<div class="line">    mantissa_bits = wordsize - ebits</div>
<div class="line">    leading_1 = 1 &lt;&lt; mantissa_bits</div>
<div class="line">    mantissa_mask = leading_1 - 1</div>
<div class="line"> </div>
<div class="line">    msb = y &gt;&gt; mantissa_bits</div>
<div class="line">    mantissa_shift = mantissa_bits - msb</div>
<div class="line">    y = (leading_1 | (y &amp; mantissa_mask)) &gt;&gt; mantissa_shift</div>
<div class="line">    return y</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md62"></a>
Approximate square roots</h1>
<p>To construct an approximate square root algorithm, start from the identity <code>log(sqrt(x)) = log(x) / 2</code>. We can easily obtain <code>sqrt(x) ~ from_log(to_log(x) &gt;&gt; 1)</code>. We can proceed by manual inlining the inner function call:</p>
<div class="fragment"><div class="line">def approx_sqrt_v0(x, wordsize=32, ebits=5):</div>
<div class="line">    if x &lt;= 1:</div>
<div class="line">        return x</div>
<div class="line">    # mantissa_bits, leading_1, mantissa_mask are independent of x</div>
<div class="line">    mantissa_bits = wordsize - ebits</div>
<div class="line">    leading_1 = 1 &lt;&lt; mantissa_bits</div>
<div class="line">    mantissa_mask = leading_1 - 1</div>
<div class="line"> </div>
<div class="line">    msb_x = x.bit_length() - 1</div>
<div class="line">    mantissa_shift_x = mantissa_bits - msb_x</div>
<div class="line">    to_log_x = (msb_x &lt;&lt; mantissa_bits) | ((x &lt;&lt; mantissa_shift_x) &amp; mantissa_mask)</div>
<div class="line"> </div>
<div class="line">    z = to_log_x &gt;&gt; 1</div>
<div class="line"> </div>
<div class="line">    msb_z = z &gt;&gt; mantissa_bits</div>
<div class="line">    mantissa_shift_z = mantissa_bits - msb_z</div>
<div class="line">    result = (leading_1 | (z &amp; mantissa_mask)) &gt;&gt; mantissa_shift_z</div>
<div class="line">    return result</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md63"></a>
Optimized approximate square roots</h1>
<p>First, consider the following simplifications:</p>
<ul>
<li>The exponent part of <code>z</code>, denoted here <code>msb_z</code>, is simply <code>msb_x &gt;&gt; 1</code></li>
<li>The MSB of the mantissa part of <code>z</code> is the low bit of <code>msb_x</code></li>
<li>The lower bits of the mantissa part of <code>z</code> are simply the bits of the mantissa part of <code>x</code> shifted once</li>
</ul>
<p>The above simplifications enable a more fundamental improvement: We can compute the mantissa and exponent of <code>z</code> directly from <code>x</code> and <code>msb_x</code>. Therefore, packing the intermediate result into <code>to_log_x</code> and then immediately unpacking it, effectively becomes a no-op and can be omitted. This makes the <code>wordsize</code> and <code>ebits</code> variables fall out. Making choices for these parameters and allocating extra space at the top of the word for exponent bits becomes completely unnecessary!</p>
<p>One subtlety is that the two shift operators result in a net shift of mantissa bits. The are shifted left by <code>mantissa_bits - msb_x</code> and then shifted right by <code>mantissa_bits - msb_z</code>. The net shift is therefore a right-shift of <code>msb_x - msb_z</code>.</p>
<p>The final code looks like this:</p>
<div class="fragment"><div class="line">def approx_sqrt_v1(x):</div>
<div class="line">    if x &lt;= 1:</div>
<div class="line">        return x</div>
<div class="line">    # mantissa_bits, leading_1, mantissa_mask are independent of x</div>
<div class="line">    msb_x = x.bit_length() - 1</div>
<div class="line">    msb_z = msb_x &gt;&gt; 1</div>
<div class="line">    msb_x_bit = 1 &lt;&lt; msb_x</div>
<div class="line">    msb_z_bit = 1 &lt;&lt; msb_z</div>
<div class="line">    mantissa_mask = msb_x_bit-1</div>
<div class="line"> </div>
<div class="line">    mantissa_x = x &amp; mantissa_mask</div>
<div class="line">    if (msb_x &amp; 1) != 0:</div>
<div class="line">        mantissa_z_hi = msb_z_bit</div>
<div class="line">    else:</div>
<div class="line">        mantissa_z_hi = 0</div>
<div class="line">    mantissa_z_lo = mantissa_x &gt;&gt; (msb_x - msb_z)</div>
<div class="line">    mantissa_z = (mantissa_z_hi | mantissa_z_lo) &gt;&gt; 1</div>
<div class="line">    result = msb_z_bit | mantissa_z</div>
<div class="line">    return result</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Jun 2 2022 11:45:29 for Scorum by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
